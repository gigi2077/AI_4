<!DOCTYPE html>
<html lang="ka">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ჰკითხე კორუფციულ საქმეებზე</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=BPG+Nino+Mtavruli&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #003366; /* Deep Blue */
            --primary-hover: #004488;
            --background-color: #f4f6f8;
            --container-bg: #ffffff;
            --text-color: #333333;
            --placeholder-color: #888888;
            --original-answer-bg: #e9e9f3; /* Original answer box color */
            --border-color: #d1d9e6;
        }

        body {
            font-family: 'BPG Nino Mtavruli', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }

        #container {
            width: 100%;
            max-width: 700px;
            background: var(--container-bg);
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.08);
            border: 1px solid var(--border-color);
        }

        h1 {
            color: var(--primary-color);
            text-align: center;
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        #subtitle {
            text-align: center;
            color: #555;
            margin-bottom: 30px;
            font-size: 16px;
        }

        textarea {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            box-sizing: border-box;
            resize: vertical;
            min-height: 100px;
            font-family: 'BPG Nino Mtavruli', sans-serif;
        }

        textarea::placeholder {
            color: var(--placeholder-color);
        }

        button {
            width: 100%;
            padding: 14px;
            font-size: 18px;
            font-weight: bold;
            color: white;
            background-color: var(--primary-color);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 15px;
            transition: background-color 0.3s ease, transform 0.1s ease;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
        }

        button:hover:not(:disabled) {
            background-color: var(--primary-hover);
        }
        
        button:active:not(:disabled) {
            transform: scale(0.99);
        }

        button:disabled {
            background-color: #9ab3cc;
            cursor: not-allowed;
        }

        #answer-box {
            margin-top: 20px;
            padding: 15px;
            background-color: var(--original-answer-bg);
            border-radius: 5px;
            min-height: 50px;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            color: var(--text-color);
            text-align: left; /* Default alignment is left */
        }
        #answer-box:not(:has(.answer-placeholder))::first-line {
            font-weight: bold;
        }
        .answer-placeholder {
            font-weight: normal;
        }
        
        #answer-box a {
            color: var(--primary-color);
            font-weight: bold;
            text-decoration: none;
        }
        
        #answer-box a:hover {
            text-decoration: underline;
        }
        
        .loader {
            width: 24px;
            height: 24px;
            border: 3px solid #FFF;
            border-bottom-color: transparent;
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }

        @keyframes rotation {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>

    <div id="container">
        <h1>დასვით კითხვა</h1>
        <p id="subtitle">Transparency.ge-ს სტატიაში მოცემული კორუფციული საქმეების შესახებ</p>
        
        <textarea id="question-input" rows="4" placeholder="მაგ., რას ამბობს სტატია სოზარ სუბარზე?"></textarea>
        
        <button id="ask-button">
            <span id="button-text">პასუხის მიღება</span>
            <svg id="button-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-send" viewBox="0 0 16 16">
                <path d="M15.854.146a.5.5 0 0 1 .11.54l-5.819 14.547a.75.75 0 0 1-1.329.124l-3.178-4.995L.643 7.184a.75.75 0 0 1 .124-1.33L15.314.037a.5.5 0 0 1 .54.11ZM6.636 10.07l2.761 4.338L14.13 2.576zm6.787-8.201L1.591 6.602l4.339 2.76z"/>
            </svg>
        </button>
        
        <div id="answer-box" role="status"><span class="answer-placeholder">პასუხი აქ გამოჩნდება...</span></div>
    </div>

    <script>
        const askButton = document.getElementById('ask-button');
        const questionInput = document.getElementById('question-input');
        const answerBox = document.getElementById('answer-box');
        const buttonText = document.getElementById('button-text');
        const buttonIcon = document.getElementById('button-icon');

        function linkifyURLs(text) {
            const urlRegex = /\[([^\]]+)\]\((https?:\/\/[^\)]+)\)/g;
            return text.replace(urlRegex, '<a href="$2" target="_blank">$1</a>');
        }

        // --- MODIFIED SECTION START ---
        function showLoading(isLoading) {
            if (isLoading) {
                askButton.disabled = true;
                buttonIcon.style.display = 'none';
                buttonText.innerHTML = '<span class="loader"></span>';
                
                // Center-align the text ONLY for the loading message
                answerBox.style.textAlign = 'center';
                answerBox.innerHTML = '<span class="answer-placeholder">ვამუშავებ ინფორმაციას, გთხოვთ დაელოდოთ...</span>';
            } else {
                askButton.disabled = false;
                buttonIcon.style.display = 'block';
                buttonText.textContent = 'პასუხის მიღება';
                
                // IMPORTANT: Revert text alignment to left for the actual answer
                answerBox.style.textAlign = 'left';
            }
        }
        // --- MODIFIED SECTION END ---

        askButton.addEventListener('click', async () => {
            const userQuestion = questionInput.value;

            if (!userQuestion.trim()) {
                answerBox.innerHTML = '<span class="answer-placeholder">გთხოვთ, ჯერ შეიყვანოთ კითხვა!</span>';
                return;
            }
            
            showLoading(true);

            try {
                const dataFileResponse = await fetch('data.txt');
                if (!dataFileResponse.ok) {
                    throw new Error('ვერ მოხერხდა data.txt ფაილის ჩატვირთვა. დარწმუნდით, რომ ის index.html-ის გვერდით მდებარეობს.');
                }
                const websiteContext = await dataFileResponse.text();
                
                const fullPrompt = `You are an expert assistant answering questions about alleged corruption cases in Georgia. You must base your answers strictly and exclusively on the provided Context. Follow these rules with extreme precision:

1.  **Relevance:** Your answer MUST ONLY contain information that is directly and specifically relevant to the user's Question. Do not include information about other cases or individuals, even if they are in the Context.
2.  **Language:** Your final, entire response MUST be in the Georgian language (ქართული).
3.  **Accuracy:** Answer only with information that is explicitly written in the Context. Do not use any external knowledge.
4.  **Style:** Answer concisely and factually. Do not add opinions.
5.  **Information Not Found:** If the answer to the Question cannot be found in the Context, you must reply with ONLY the following Georgian phrase: "მოწოდებულ ტექსტში ამის შესახებ ინფორმაციას ვერ ვპოულობ."
6.  **Citation:** At the end of your answer, you MUST cite the original source. To do this, find the line at the end of the relevant section in the Context that begins with \`წყარო:\` and exactly copy the source name and its URL. Cite it in the following format: "წყარო: [source name](source URL)". Do not include any other text or explanations.

---
**Context:**
${websiteContext}
---

**Question:**
${userQuestion}`;

                const apiResponse = await fetch(`/api/prompt`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt: fullPrompt })
                });

                if (!apiResponse.ok) {
                    const errorData = await apiResponse.json();
                    throw new Error(`API შეცდომა: ${errorData.error}`);
                }

                const responseData = await apiResponse.json();
                
                if (responseData.candidates && responseData.candidates.length > 0) {
                    const answer = responseData.candidates[0].content.parts[0].text;
                    answerBox.innerHTML = linkifyURLs(answer);
                } else {
                    answerBox.innerHTML = '<span class="answer-placeholder">მოდელმა არასწორი პასუხი დააბრუნა. გთხოვთ, სცადოთ თავიდან.</span>';
                }

            } catch (error) {
                console.error("Error:", error);
                answerBox.innerHTML = `<span class="answer-placeholder">დაფიქსირდა შეცდომა: ${error.message}</span>`;
            } finally {
                // --- MODIFIED SECTION START ---
                // This 'finally' block ensures the loading state is always turned off,
                // whether the API call succeeds or fails.
                showLoading(false);
                // --- MODIFIED SECTION END ---
            }
        });
    </script>
</body>
</html>